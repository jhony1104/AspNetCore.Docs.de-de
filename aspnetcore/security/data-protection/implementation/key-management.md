---
title: Schlüsselverwaltung in ASP.net Core
author: rick-anderson
description: Erfahren Sie mehr über die Implementierungsdetails der APIs für die ASP.net Core Datenschutz-Schlüsselverwaltung.
ms.author: riande
ms.date: 10/14/2016
no-loc:
- Blazor
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 0f54ceedf3558fb4fa2349903461fdfdb4dc02e6
ms.sourcegitcommit: 70e5f982c218db82aa54aa8b8d96b377cfc7283f
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 05/04/2020
ms.locfileid: "82776902"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="c36f7-103">Schlüsselverwaltung in ASP.net Core</span><span class="sxs-lookup"><span data-stu-id="c36f7-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="c36f7-104">Das Datenschutzsystem verwaltet die Lebensdauer von Haupt Schlüsseln, die zum Schutz und zum Aufheben des Schutzes von Nutzlasten verwendet werden, automatisch.</span><span class="sxs-lookup"><span data-stu-id="c36f7-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="c36f7-105">Jeder Schlüssel kann in einer von vier Phasen vorhanden sein:</span><span class="sxs-lookup"><span data-stu-id="c36f7-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="c36f7-106">Erstellt: der Schlüssel ist im Schlüsselbund vorhanden, wurde jedoch noch nicht aktiviert.</span><span class="sxs-lookup"><span data-stu-id="c36f7-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="c36f7-107">Der Schlüssel sollte nicht für neue Schutz Vorgänge verwendet werden, bis ausreichend Zeit verstrichen ist, dass der Schlüssel an alle Computer weitergegeben werden konnte, die diesen Schlüsselbund verbrauchen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="c36f7-108">Aktiv: der Schlüssel ist im Schlüsselbund vorhanden und sollte für alle neuen Schutz Vorgänge verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="c36f7-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="c36f7-109">Abgelaufen: der Schlüssel hat seine natürliche Lebensdauer ausgeführt und sollte nicht mehr für neue Schutz Vorgänge verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="c36f7-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="c36f7-110">Widerrufen: der Schlüssel ist kompromittiert und darf nicht für neue Schutz Vorgänge verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="c36f7-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="c36f7-111">Die Schlüssel "erstellt", "aktiv" und "abgelaufen" können alle zum Aufheben des Schutzes eingehender Nutzlasten verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="c36f7-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="c36f7-112">Widerrufene Schlüssel können standardmäßig nicht zum Aufheben des Schutzes von Nutzlasten verwendet werden, aber der Anwendungsentwickler kann [dieses Verhalten](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) bei Bedarf überschreiben.</span><span class="sxs-lookup"><span data-stu-id="c36f7-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="c36f7-113">Der Entwickler kann einen Schlüssel aus dem Schlüsselbund löschen (z. b. durch Löschen der entsprechenden Datei aus dem Dateisystem).</span><span class="sxs-lookup"><span data-stu-id="c36f7-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="c36f7-114">An diesem Punkt sind alle Daten, die durch den Schlüssel geschützt sind, unwiderruflich unverschlüsselt, und es gibt keine notfallaußerkraftsetzung, wie es bei widerrufenen Schlüsseln der Fall ist.</span><span class="sxs-lookup"><span data-stu-id="c36f7-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="c36f7-115">Das Löschen eines Schlüssels ist wirklich destruktives Verhalten, und folglich stellt das Datenschutzsystem keine erstklassige API zum Ausführen dieses Vorgangs zur Verfügung.</span><span class="sxs-lookup"><span data-stu-id="c36f7-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="c36f7-116">Standardschlüssel Auswahl</span><span class="sxs-lookup"><span data-stu-id="c36f7-116">Default key selection</span></span>

<span data-ttu-id="c36f7-117">Wenn das Datenschutzsystem den Schlüsselbund aus dem sicherungsrepository liest, wird versucht, einen "Default"-Schlüssel aus dem Schlüsselbund zu suchen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="c36f7-118">Der Standardschlüssel wird für neue Protect-Vorgänge verwendet.</span><span class="sxs-lookup"><span data-stu-id="c36f7-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="c36f7-119">Die allgemeine Heuristik besteht darin, dass das Datenschutzsystem den Schlüssel mit dem aktuellsten Aktivierungsdatum als Standardschlüssel auswählt.</span><span class="sxs-lookup"><span data-stu-id="c36f7-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="c36f7-120">(Es gibt einen kleinen Mogel-Faktor, der die Server-zu-Server-Takt Neigung zulässt.) Wenn der Schlüssel abgelaufen ist oder widerrufen wird und die automatische Schlüsselgenerierung von der Anwendung nicht deaktiviert wurde, wird ein neuer Schlüssel mit sofortiger Aktivierung gemäß dem [Schlüssel Ablauf und](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) der aktuellen rollenrichtlinie generiert.</span><span class="sxs-lookup"><span data-stu-id="c36f7-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="c36f7-121">Der Grund, warum das Datenschutzsystem einen neuen Schlüssel direkt generiert, anstatt auf einen anderen Schlüssel zurückzukehren, besteht darin, dass die neue Schlüsselgenerierung als impliziter Ablauf aller Schlüssel behandelt werden soll, die vor dem neuen Schlüssel aktiviert wurden.</span><span class="sxs-lookup"><span data-stu-id="c36f7-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="c36f7-122">Die allgemeine Idee ist, dass neue Schlüssel möglicherweise mit verschiedenen Algorithmen oder Verschlüsselungs-at-Rest-Mechanismen konfiguriert wurden, als alte Schlüssel. das System sollte die aktuelle Konfiguration vor dem Fallback bevorzugen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="c36f7-123">Es gibt eine Ausnahme.</span><span class="sxs-lookup"><span data-stu-id="c36f7-123">There's an exception.</span></span> <span data-ttu-id="c36f7-124">Wenn der Anwendungsentwickler die [automatische Schlüsselgenerierung deaktiviert](xref:security/data-protection/configuration/overview#disableautomatickeygeneration)hat, muss das Datenschutzsystem etwas als Standardschlüssel auswählen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="c36f7-125">In diesem Fall Back Szenario wählt das System den nicht widerrufenen Schlüssel mit dem aktuellen Aktivierungsdatum aus, wobei Schlüssel für Schlüssel, die Zeit für die Weitergabe an andere Computer im Cluster hatten, Vorrang haben.</span><span class="sxs-lookup"><span data-stu-id="c36f7-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="c36f7-126">Das Fall Back System wählt möglicherweise einen abgelaufenen Standardschlüssel aus.</span><span class="sxs-lookup"><span data-stu-id="c36f7-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="c36f7-127">Das Fall Back System wählt niemals einen gesperrten Schlüssel als Standardschlüssel aus, und wenn der Schlüsselbund leer ist oder jeder Schlüssel widerrufen wurde, erzeugt das System bei der Initialisierung einen Fehler.</span><span class="sxs-lookup"><span data-stu-id="c36f7-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="c36f7-128">Schlüssel Ablauf und-parallele</span><span class="sxs-lookup"><span data-stu-id="c36f7-128">Key expiration and rolling</span></span>

<span data-ttu-id="c36f7-129">Wenn ein Schlüssel erstellt wird, wird automatisch ein Aktivierungsdatum von {Now + 2 Days} und ein Ablaufdatum von {Now + 90 Tage} angegeben.</span><span class="sxs-lookup"><span data-stu-id="c36f7-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="c36f7-130">Die 2-tägige Verzögerung vor der Aktivierung gibt die Schlüsselzeit für die Weitergabe über das System an.</span><span class="sxs-lookup"><span data-stu-id="c36f7-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="c36f7-131">Dies bedeutet, dass andere Anwendungen, die auf den Sicherungs Speicher zeigen, den Schlüssel beim nächsten automatischen Aktualisierungs Zeitraum beobachten können. Dadurch wird die Wahrscheinlichkeit maximiert, dass der Schlüsselbund aktiv wird, wenn er an alle Anwendungen weitergegeben wird, die ihn möglicherweise verwenden müssen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="c36f7-132">Wenn der Standardschlüssel innerhalb von 2 Tagen abläuft und der Schlüsselbund nicht bereits über einen Schlüssel verfügt, der nach Ablauf des Standard Schlüssels aktiv sein wird, speichert das Datenschutzsystem automatisch einen neuen Schlüssel für den Schlüsselbund.</span><span class="sxs-lookup"><span data-stu-id="c36f7-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="c36f7-133">Dieser neue Schlüssel weist das Aktivierungsdatum "{Standard Key es Ablaufdatum}" und das Ablaufdatum "{now + 90 Days}" auf.</span><span class="sxs-lookup"><span data-stu-id="c36f7-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="c36f7-134">Dadurch kann das System regelmäßig automatisch ein Rollback für Schlüssel ausführen, ohne Dienst Unterbrechung auszuführen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="c36f7-135">Möglicherweise gibt es Situationen, in denen ein Schlüssel mit sofortiger Aktivierung erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="c36f7-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="c36f7-136">Ein Beispiel wäre, wenn die Anwendung nicht für eine Zeit ausgeführt wurde und alle Schlüssel im Schlüsselbund abgelaufen sind.</span><span class="sxs-lookup"><span data-stu-id="c36f7-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="c36f7-137">Wenn dies der Fall ist, erhält der Schlüssel ein Aktivierungsdatum von {Now} ohne die normale zweitägige Aktivierungs Verzögerung.</span><span class="sxs-lookup"><span data-stu-id="c36f7-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="c36f7-138">Der Standardwert für die Schlüssel Lebensdauer beträgt 90 Tage. Dies kann jedoch wie im folgenden Beispiel konfiguriert werden.</span><span class="sxs-lookup"><span data-stu-id="c36f7-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="c36f7-139">Ein Administrator kann auch die standardmäßige systemweite ändern, obwohl ein expliziter `SetDefaultKeyLifetime` -Vorgang eine beliebige systemweite Richtlinie außer Kraft setzt.</span><span class="sxs-lookup"><span data-stu-id="c36f7-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="c36f7-140">Die Standard Gültigkeitsdauer des Schlüssels darf nicht kürzer als 7 Tage sein.</span><span class="sxs-lookup"><span data-stu-id="c36f7-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="c36f7-141">Automatische Aktualisierung des Schlüsselrings</span><span class="sxs-lookup"><span data-stu-id="c36f7-141">Automatic key ring refresh</span></span>

<span data-ttu-id="c36f7-142">Beim Initialisieren des Datenschutzsystems liest es den Schlüsselring aus dem zugrunde liegenden Repository und speichert ihn im Arbeitsspeicher zwischen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="c36f7-143">Mit diesem Cache können Vorgänge zum Schutz und zum Aufheben des Schutzes fortgesetzt werden, ohne den Sicherungs Speicher zu erreichen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="c36f7-144">Das System überprüft den Sicherungs Speicher automatisch auf Änderungen ungefähr alle 24 Stunden oder, wenn der aktuelle Standardschlüssel abläuft, je nachdem, welcher Fall zuerst eintritt.</span><span class="sxs-lookup"><span data-stu-id="c36f7-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="c36f7-145">Entwickler sollten die Schlüsselverwaltungs-APIs in sehr seltenen Fällen (Falls immer) direkt verwenden müssen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="c36f7-146">Das Datenschutzsystem führt die automatische Schlüsselverwaltung wie oben beschrieben aus.</span><span class="sxs-lookup"><span data-stu-id="c36f7-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="c36f7-147">Das Datenschutzsystem macht eine Schnitt `IKeyManager` Stelle verfügbar, die verwendet werden kann, um den Schlüsselring zu überprüfen und zu ändern.</span><span class="sxs-lookup"><span data-stu-id="c36f7-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="c36f7-148">Das di-System, das die Instanz `IDataProtectionProvider` von bereitstellt, kann auch `IKeyManager` eine Instanz von für den Verbrauch bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="c36f7-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="c36f7-149">Alternativ können Sie den `IKeyManager` direkt von der `IServiceProvider` abrufen, wie im folgenden Beispiel gezeigt.</span><span class="sxs-lookup"><span data-stu-id="c36f7-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="c36f7-150">Jeder Vorgang, bei dem der Schlüsselbund geändert wird (durch explizites Erstellen eines neuen Schlüssels oder Durchführen einer Sperre) wird der in-Memory-Cache ungültig.</span><span class="sxs-lookup"><span data-stu-id="c36f7-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="c36f7-151">Beim nächsten Aufrufen von `Protect` oder `Unprotect` wird das Datenschutzsystem zum erneuten Einlesen des Schlüsselrings und zum erneuten Erstellen des Caches.</span><span class="sxs-lookup"><span data-stu-id="c36f7-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="c36f7-152">Das folgende Beispiel veranschaulicht die Verwendung `IKeyManager` der-Schnittstelle, um den Schlüsselring zu überprüfen und zu bearbeiten, einschließlich der Aufhebung vorhandener Schlüssel und der manuellen Erstellung eines neuen Schlüssels.</span><span class="sxs-lookup"><span data-stu-id="c36f7-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

## <a name="key-storage"></a><span data-ttu-id="c36f7-153">Schlüsselspeicher</span><span class="sxs-lookup"><span data-stu-id="c36f7-153">Key storage</span></span>

<span data-ttu-id="c36f7-154">Das Datenschutzsystem hat eine Heuristik, bei der versucht wird, einen geeigneten Schlüssel Speicherort und den Verschlüsselungs-at-Rest-Mechanismus automatisch herzuleiten.</span><span class="sxs-lookup"><span data-stu-id="c36f7-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="c36f7-155">Der Schlüssel Persistenzmechanismus kann auch vom App-Entwickler konfiguriert werden.</span><span class="sxs-lookup"><span data-stu-id="c36f7-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="c36f7-156">In den folgenden Dokumenten werden die in-Box-Implementierungen dieser Mechanismen erläutert:</span><span class="sxs-lookup"><span data-stu-id="c36f7-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
